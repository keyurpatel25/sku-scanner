<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>FabAlley SKU Scanner</title>

    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        /* Custom Styles */
        body { background: #f5f8fc; font-family: 'Inter', sans-serif; }
        #video-container { position: relative; border-radius: 12px; overflow: hidden; background: #000; }
        
        /* Scanning Box Visuals */
        .scan-box {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            width: 250px; height: 150px;
            border: 2px solid #22c55e; /* Green Border */
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(34,197,94,0.6);
            z-index: 10; /* Ensure box is above camera feed */
        }
        .scan-line {
            position: absolute;
            width: 100%; height: 2px;
            top: 0;
            background: linear-gradient(to right, transparent, #22c55e, transparent);
            animation: scan-move 1.5s infinite alternate; /* Faster animation */
        }
        @keyframes scan-move { 0% { top: 0; } 100% { top: calc(100% - 2px); } }
    </style>
</head>

<body class="flex justify-center items-center min-h-screen p-4">
    <div class="w-full max-w-md bg-white rounded-2xl shadow-lg p-6">
        <h1 class="text-2xl font-bold text-center mb-2">FabAlley SKU Scanner</h1>
        <p class="text-center text-gray-500 mb-4">Scan or enter SKU to view product image</p>

        <div id="video-container" class="aspect-video relative mb-4">
            <div id="cameraPreview" class="w-full h-full"></div>
            <div class="scan-box"><div class="scan-line"></div></div>
        </div>

        <div class="flex gap-2 mb-3">
            <input id="skuInput" type="text" placeholder="Enter SKU"
                class="flex-1 border border-gray-300 p-3 rounded-lg text-center text-lg uppercase font-semibold tracking-wider" />
            <button id="lookupBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-3 rounded-lg font-semibold">
                Lookup
            </button>
        </div>

        <div class="flex justify-center gap-2 mb-3">
            <button id="startBtn" class="bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-6 rounded-lg shadow-md">Start Scan</button>
            <button id="stopBtn" class="bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-6 rounded-lg shadow-md hidden">Stop</button>
        </div>

        <div id="statusMessage" class="text-center text-gray-600 text-sm mb-3">Scanner not active</div>

        <div class="relative w-full aspect-square bg-gray-100 rounded-lg overflow-hidden flex items-center justify-center p-4">
            <img id="productImage" src="" alt="Product Image" class="max-h-full object-contain opacity-0 transition-opacity duration-300" />
            <div id="placeholder" class="text-gray-400 text-center absolute">Enter or scan SKU</div>
        </div>
    </div>

    <script src="quagga.min.js"></script>

    <script>
        const skuInput = document.getElementById("skuInput");
        const productImage = document.getElementById("productImage");
        const placeholder = document.getElementById("placeholder");
        const startBtn = document.getElementById("startBtn");
        const stopBtn = document.getElementById("stopBtn");
        const statusMsg = document.getElementById("statusMessage");
        const lookupBtn = document.getElementById("lookupBtn");

        const IMAGE_BASE_URL = "https://img.faballey.com/images/Product/";
        const IMAGE_SUFFIX = "/1.jpg";

        let lastScanned = "";
        let isScanning = false;
        let isLoading = false;
        let currentAbortController = null; // For cancelling fetch requests
        let detectionTimeout = null;      // For debouncing scan results

        // --- UTILITY FUNCTIONS ---

        /** * Resets the UI state for the product image display. */
        function resetUI() {
            productImage.classList.add("opacity-0");
            productImage.removeAttribute("src");
            placeholder.style.display = "block";
            placeholder.textContent = "Enter or scan SKU";
        }

        // ðŸ”¹ Start Scanner
        async function startScanner() {
            if (isScanning) return;
            const granted = await ensureCameraAccess();
            if (!granted) return;

            resetUI();
            statusMsg.textContent = "Starting camera...";
            startBtn.classList.add("hidden");
            stopBtn.classList.remove("hidden");

            Quagga.init({
                inputStream: {
                    type: "LiveStream",
                    constraints: {
                        facingMode: "environment",
                        // OPTIMIZATION: Lower resolution for faster frame processing
                        width: { ideal: 640 },
                        height: { ideal: 480 }
                    },
                    target: document.querySelector("#cameraPreview")
                },
                decoder: { 
                    // OPTIMIZATION: Use only the necessary decoder for SKUs (Code 128 is common)
                    readers: ["code_128_reader"] 
                },
                locate: true,
                // OPTIMIZATION: Process 10 frames per second instead of maximum
                frequency: 10,
                // OPTIMIZATION: Focus scanning on the center area
                area: {
                    top: "20%",
                    right: "25%",
                    left: "25%",
                    bottom: "20%"
                }
            }, (err) => {
                if (err) {
                    console.error(err);
                    alert("Failed to start camera: " + err);
                    statusMsg.textContent = "Camera error.";
                    startBtn.classList.remove("hidden");
                    stopBtn.classList.add("hidden");
                    return;
                }
                Quagga.start();
                isScanning = true;
                statusMsg.textContent = "ðŸ“· Scanning barcode...";
            });

            Quagga.onDetected(onDetected);
        }

        // ðŸ”¹ Ensure camera permission
        async function ensureCameraAccess() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
                stream.getTracks().forEach(t => t.stop());
                return true;
            } catch (e) {
                alert("Camera permission denied or not available.");
                console.error(e);
                return false;
            }
        }

        // ðŸ”¹ Stop Scanner
        function stopScanner() {
            if (!isScanning) return;
            Quagga.stop();
            isScanning = false;
            startBtn.classList.remove("hidden");
            stopBtn.classList.add("hidden");
            statusMsg.textContent = "Scanner stopped.";
        }

        // ðŸ”¹ Handle Detected Barcode (debounced)
        function onDetected(result) {
            const code = result.codeResult.code.trim().toUpperCase();

            if (code === lastScanned) return;

            // Debounce: Wait a small period (150ms) to ensure it's the final scan result
            clearTimeout(detectionTimeout);
            detectionTimeout = setTimeout(async () => {
                lastScanned = code;
                statusMsg.textContent = `âœ… SKU Detected: ${code}`;
                skuInput.value = code;
                await fetchImage(code);
            }, 150);
        }

        // ðŸ”¹ Fetch image with fast Aâ€“Z logic
        async function fetchImage(sku) {
            // RELIABILITY: Abort previous pending requests
            if (currentAbortController) {
                currentAbortController.abort();
            }
            currentAbortController = new AbortController();
            const { signal } = currentAbortController;

            isLoading = true;
            skuInput.value = sku;
            resetUI();
            placeholder.textContent = "Loading...";
            statusMsg.textContent = `Loading image for ${sku}...`;

            const urls = [];
            // 1. Exact SKU check
            const exactUrl = `${IMAGE_BASE_URL}${sku}${IMAGE_SUFFIX}`;
            urls.push(exactUrl);

            // 2. A-Z Fallback Logic (XMS29756C -> XMS29756A, XMS29756B, etc.)
            const base = sku.slice(0, -1);
            const letters = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
            for (const ch of letters) {
                // Skip the exact match, already checked
                if (`${base}${ch}` === sku) continue; 
                urls.push(`${IMAGE_BASE_URL}${base}${ch}${IMAGE_SUFFIX}`);
            }

            try {
                for (const url of urls) {
                    const found = await checkImage(url, signal); // Fast HEAD check
                    if (found) {
                        showImage(url, sku); // Immediately sets src and loads image
                        isLoading = false;
                        return; // FOUND IMAGE: Skip all other checks and exit
                    }
                }

                // No image found after all checks
                statusMsg.textContent = "âš ï¸ No image found.";
                placeholder.style.display = "block";
                placeholder.textContent = "Image not found.";

            } catch (error) {
                if (error.name === 'AbortError') {
                    statusMsg.textContent = "Image search cancelled.";
                    return; 
                }
                console.error("Fetch error:", error);
                statusMsg.textContent = "Image lookup failed (Network error).";
            } finally {
                isLoading = false;
                currentAbortController = null;
            }
        }

        // ðŸ”¹ Show image
        function showImage(url, sku) {
            placeholder.style.display = "none";
            
            // Use event listeners for reliable load and error handling
            productImage.onload = () => {
                productImage.classList.remove("opacity-0");
                statusMsg.textContent = `âœ… Image loaded for ${sku}`;
                productImage.onload = null; // Clear handler
            };
            productImage.onerror = () => {
                statusMsg.textContent = `âš ï¸ Failed to display image for ${sku}`;
                resetUI();
                placeholder.textContent = "Image failed to load.";
                productImage.onerror = null; // Clear handler
            };

            productImage.src = url;
        }

        // ðŸ”¹ Check if image exists (HEAD request)
        async function checkImage(url, signal) {
            try {
                // Pass signal for cancellation
                const res = await fetch(url, { method: "HEAD", signal });
                return res.ok;
            } catch (e) {
                if (e.name === 'AbortError') throw e; // Re-throw cancellation error
                return false;
            }
        }

        // --- EVENT LISTENERS ---

        // Manual lookup on button click
        lookupBtn.addEventListener("click", async () => {
            const sku = skuInput.value.trim().toUpperCase();
            if (sku) await fetchImage(sku);
        });

        // Manual lookup on Enter key press
        skuInput.addEventListener("keydown", async (e) => {
            if (e.key === "Enter") {
                e.preventDefault();
                const sku = skuInput.value.trim().toUpperCase();
                if (sku) await fetchImage(sku);
            }
        });

        startBtn.addEventListener("click", startScanner);
        stopBtn.addEventListener("click", stopScanner);
        
        // Initial UI state setup
        resetUI();
    </script>
</body>
</html>
