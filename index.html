<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>FabAlley SKU Scanner</title>

  <!-- Tailwind for styling -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    body { background: #f4f7fb; font-family: 'Inter', sans-serif; }
    #video-container { position: relative; border-radius: 12px; overflow: hidden; background: #000; }
    .scan-box {
      position: absolute;
      top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      width: 250px; height: 150px;
      border: 2px solid #22c55e;
      border-radius: 10px;
      box-shadow: 0 0 20px rgba(34,197,94,0.6);
    }
    .scan-line {
      position: absolute;
      width: 100%; height: 2px;
      top: 0;
      background: linear-gradient(to right, transparent, #22c55e, transparent);
      animation: scan-move 2s infinite alternate;
    }
    @keyframes scan-move { 0% { top: 0; } 100% { top: calc(100% - 2px); } }
  </style>
</head>

<body class="flex justify-center items-center min-h-screen p-4">
  <div class="w-full max-w-md bg-white rounded-2xl shadow-lg p-6">
    <h1 class="text-2xl font-bold text-center mb-2">FabAlley SKU Scanner</h1>
    <p class="text-center text-gray-500 mb-4">Scan or enter SKU to view product image</p>

    <div id="video-container" class="aspect-video relative mb-4">
      <div id="cameraPreview" class="w-full h-full"></div>
      <div class="scan-box"><div class="scan-line"></div></div>
    </div>

    <div class="flex gap-2 mb-3">
      <input id="skuInput" type="text" placeholder="Enter SKU"
        class="flex-1 border border-gray-300 p-3 rounded-lg text-center text-lg uppercase font-semibold tracking-wider" />
      <button id="lookupBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-3 rounded-lg font-semibold">
        Lookup
      </button>
    </div>

    <div class="flex justify-center gap-2 mb-3">
      <button id="startBtn" class="bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-6 rounded-lg shadow-md">Start Scan</button>
      <button id="stopBtn" class="bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-6 rounded-lg shadow-md hidden">Stop</button>
    </div>

    <div id="statusMessage" class="text-center text-gray-600 text-sm mb-3">Camera not active</div>

    <div class="relative w-full aspect-square bg-gray-100 rounded-lg overflow-hidden flex items-center justify-center p-4">
      <img id="productImage" src="" alt="Product Image" class="max-h-full object-contain opacity-0 transition-opacity duration-300" />
      <div id="placeholder" class="text-gray-400 text-center absolute">Enter or scan SKU</div>
    </div>
  </div>

  <!-- Include Quagga -->
  <script src="quagga.min.js"></script>

  <script>
    const skuInput = document.getElementById("skuInput");
    const productImage = document.getElementById("productImage");
    const placeholder = document.getElementById("placeholder");
    const startBtn = document.getElementById("startBtn");
    const stopBtn = document.getElementById("stopBtn");
    const statusMsg = document.getElementById("statusMessage");

    const IMAGE_BASE_URL = "https://img.faballey.com/images/Product/";
    const IMAGE_SUFFIX = "/1.jpg";

    let isScanning = false;

    async function startScanner() {
      if (isScanning) return;
      const granted = await ensureCameraAccess();
      if (!granted) return;

      statusMsg.textContent = "Starting camera...";
      startBtn.classList.add("hidden");
      stopBtn.classList.remove("hidden");

      Quagga.init({
        inputStream: {
          type: "LiveStream",
          constraints: {
            facingMode: "environment",
            width: { ideal: 1280 },
            height: { ideal: 720 }
          },
          target: document.querySelector("#cameraPreview")
        },
        decoder: { readers: ["code_128_reader", "code_39_reader"] },
        locate: true
      }, (err) => {
        if (err) {
          console.error(err);
          alert("Failed to start camera: " + err);
          statusMsg.textContent = "Camera error.";
          startBtn.classList.remove("hidden");
          stopBtn.classList.add("hidden");
          return;
        }
        Quagga.start();
        isScanning = true;
        statusMsg.textContent = "ðŸ“· Scanning barcode...";
      });

      Quagga.onDetected(onDetected);
    }

    async function ensureCameraAccess() {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
        stream.getTracks().forEach(t => t.stop());
        return true;
      } catch (e) {
        alert("Camera permission denied or not available.");
        console.error(e);
        return false;
      }
    }

    function stopScanner() {
      if (!isScanning) return;
      Quagga.stop();
      isScanning = false;
      startBtn.classList.remove("hidden");
      stopBtn.classList.add("hidden");
      statusMsg.textContent = "Scanner stopped.";
    }

    function onDetected(result) {
      const code = result.codeResult.code.trim().toUpperCase();
      console.log("Scanned:", code);
      stopScanner();
      skuInput.value = code;
      fetchImage();
      statusMsg.textContent = `âœ… SKU Detected: ${code}`;
    }

    async function fetchImage() {
      const sku = skuInput.value.trim().toUpperCase();
      if (!sku) return;
      placeholder.style.display = "none";
      productImage.classList.add("opacity-0");
      statusMsg.textContent = `Loading image for ${sku}...`;

      const exactUrl = `${IMAGE_BASE_URL}${sku}${IMAGE_SUFFIX}`;
      if (await checkImage(exactUrl)) return showImage(exactUrl, sku);

      const base = sku.slice(0, -1);
      const letters = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
      for (const ch of letters) {
        const altUrl = `${IMAGE_BASE_URL}${base}${ch}${IMAGE_SUFFIX}`;
        if (await checkImage(altUrl)) return showImage(altUrl, base + ch);
      }

      statusMsg.textContent = "âš ï¸ No image found.";
      placeholder.style.display = "block";
      placeholder.textContent = "Image not found.";
    }

    function showImage(url, sku) {
      productImage.src = url;
      productImage.onload = () => {
        productImage.classList.remove("opacity-0");
        placeholder.style.display = "none";
        statusMsg.textContent = `âœ… Image loaded for ${sku}`;
      };
    }

    async function checkImage(url) {
      try {
        const res = await fetch(url, { method: "HEAD" });
        return res.ok;
      } catch {
        return false;
      }
    }

    startBtn.addEventListener("click", startScanner);
    stopBtn.addEventListener("click", stopScanner);
    document.getElementById("lookupBtn").addEventListener("click", fetchImage);
  </script>
</body>
</html>
