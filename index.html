<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SKU Barcode Scanner</title>

  <!-- Tailwind CSS for layout -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    body { background-color: #f5f7fa; font-family: 'Inter', sans-serif; }
    #video-container { position: relative; border-radius: 12px; overflow: hidden; background: #000; }
    #video { width: 100%; height: auto; }
    .scan-box {
      position: absolute;
      top: 50%; left: 50%;
      width: 250px; height: 150px;
      transform: translate(-50%, -50%);
      border: 2px solid #10b981;
      border-radius: 10px;
      box-shadow: 0 0 20px rgba(16,185,129,0.6);
    }
    .scan-line {
      position: absolute;
      top: 0; left: 0;
      width: 100%; height: 2px;
      background: linear-gradient(to right, transparent, #10b981, transparent);
      animation: scan-move 2s infinite alternate;
    }
    @keyframes scan-move { 0% { top: 0; } 100% { top: calc(100% - 2px); } }
  </style>
</head>

<body class="p-4 min-h-screen flex items-center justify-center">

  <div class="w-full max-w-md bg-white shadow-lg rounded-xl p-6">
    <h1 class="text-2xl font-bold text-gray-800 mb-2 text-center">FabAlley SKU Scanner</h1>
    <p class="text-gray-500 text-center mb-4">Scan barcode or enter SKU to view product image</p>

    <div id="video-container" class="relative w-full aspect-video mb-4">
      <video id="video" autoplay muted playsinline></video>
      <div class="scan-box">
        <div class="scan-line"></div>
      </div>
    </div>

    <div class="flex flex-col sm:flex-row gap-3 mb-4">
      <input id="skuInput" type="text" placeholder="Enter SKU" 
        class="flex-1 border border-gray-300 p-3 rounded-lg text-center text-lg uppercase font-semibold tracking-wider" />
      <button id="lookupBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-3 rounded-lg font-semibold">
        Lookup
      </button>
    </div>

    <div class="flex justify-center mb-4">
      <button id="startBtn" class="bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-6 rounded-lg shadow-md">
        Start Scan
      </button>
      <button id="stopBtn" class="bg-red-600 hover:bg-red-700 text-white font-semibold py-3 px-6 rounded-lg ml-2 rounded-lg shadow-md hidden">
        Stop
      </button>
    </div>

    <div id="statusMessage" class="text-center text-gray-500 text-sm mb-3">Camera not active</div>

    <div class="w-full aspect-square bg-gray-100 rounded-lg overflow-hidden flex items-center justify-center p-4">
      <img id="productImage" src="" alt="Product Image" class="max-h-full object-contain opacity-0 transition-opacity duration-300" />
      <div id="placeholder" class="text-gray-400 text-center absolute">Enter or scan SKU</div>
    </div>
  </div>

  <!-- QuaggaJS -->
  <script src="quagga.min.js"></script>

  <script>
    const skuInput = document.getElementById("skuInput");
    const productImage = document.getElementById("productImage");
    const placeholder = document.getElementById("placeholder");
    const startBtn = document.getElementById("startBtn");
    const stopBtn = document.getElementById("stopBtn");
    const statusMsg = document.getElementById("statusMessage");

    const IMAGE_BASE_URL = "https://img.faballey.com/images/Product/";
    const IMAGE_SUFFIX = "/1.jpg";
    let isScanning = false;

    // =============== CAMERA + SCANNER SETUP ===============
    async function startScanner() {
      if (isScanning) return;
      const granted = await requestCameraAccess();
      if (!granted) return;

      statusMsg.textContent = "Initializing scanner...";
      startBtn.classList.add("hidden");
      stopBtn.classList.remove("hidden");

      Quagga.init({
        inputStream: {
          name: "Live",
          type: "LiveStream",
          target: document.querySelector("#video"),
          constraints: { facingMode: "environment" }
        },
        decoder: { readers: ["code_128_reader", "code_39_reader"] },
        locate: true
      }, (err) => {
        if (err) {
          console.error(err);
          statusMsg.textContent = "Failed to start camera.";
          startBtn.classList.remove("hidden");
          stopBtn.classList.add("hidden");
          return;
        }
        Quagga.start();
        isScanning = true;
        statusMsg.textContent = "ðŸ“· Scanning for barcode...";
      });

      Quagga.onDetected(onDetected);
    }

    async function requestCameraAccess() {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
        stream.getTracks().forEach(t => t.stop());
        return true;
      } catch (err) {
        alert("Camera access denied.");
        console.error(err);
        return false;
      }
    }

    function stopScanner() {
      if (!isScanning) return;
      Quagga.stop();
      isScanning = false;
      startBtn.classList.remove("hidden");
      stopBtn.classList.add("hidden");
      statusMsg.textContent = "Scanner stopped.";
    }

    // =============== ON BARCODE DETECTED ===============
    function onDetected(result) {
      const code = result.codeResult.code.trim().toUpperCase();
      console.log("Scanned:", code);
      stopScanner();
      skuInput.value = code;
      fetchImage();
      statusMsg.textContent = `âœ… SKU Detected: ${code}`;
    }

    // =============== SKU IMAGE FETCH LOGIC ===============
    async function fetchImage() {
      const sku = skuInput.value.trim().toUpperCase();
      if (!sku) return;
      placeholder.style.display = "none";
      productImage.classList.add("opacity-0");
      statusMsg.textContent = `Loading image for ${sku}...`;

      const base = sku.slice(0, -1);
      const last = sku.slice(-1);

      // First try exact SKU
      const exactUrl = `${IMAGE_BASE_URL}${sku}${IMAGE_SUFFIX}`;
      if (await checkImage(exactUrl)) {
        showImage(exactUrl, sku);
        return;
      }

      // If not found, try Aâ†’Z slowly
      const letters = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
      for (const ch of letters) {
        const altUrl = `${IMAGE_BASE_URL}${base}${ch}${IMAGE_SUFFIX}`;
        const ok = await checkImage(altUrl);
        if (ok) {
          showImage(altUrl, base + ch);
          return;
        }
      }

      statusMsg.textContent = "âš ï¸ No image found.";
      placeholder.style.display = "block";
      placeholder.textContent = "Image not found.";
    }

    function showImage(url, sku) {
      productImage.src = url;
      productImage.onload = () => {
        productImage.classList.remove("opacity-0");
        placeholder.style.display = "none";
        statusMsg.textContent = `âœ… Image loaded for ${sku}`;
      };
    }

    async function checkImage(url) {
      try {
        const res = await fetch(url, { method: "HEAD" });
        return res.ok;
      } catch {
        return false;
      }
    }

    // =============== BUTTON EVENTS ===============
    startBtn.addEventListener("click", startScanner);
    stopBtn.addEventListener("click", stopScanner);
    document.getElementById("lookupBtn").addEventListener("click", fetchImage);
  </script>

</body>
</html>
