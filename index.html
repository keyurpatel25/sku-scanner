<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Product SKU Barcode Scanner</title>

  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    body { font-family: Inter, sans-serif; background: #f7f7f7; }
    #reader { max-width: 100%; height: 300px; border-radius: .5rem; background: #000; overflow: hidden; position: relative; }
    .scanner-line { position: absolute; top: 0; left: 0; width: 100%; height: 2px; background: linear-gradient(to right, transparent, #10b981, transparent); animation: scan-move 2s infinite alternate ease-in-out; z-index: 10; }
    @keyframes scan-move { 0% { top: 0%; } 100% { top: 98%; } }
  </style>
</head>

<body class="p-4 sm:p-8 min-h-screen flex items-start justify-center">
  <div class="w-full max-w-xl bg-white shadow-xl rounded-xl p-6 md:p-8 border border-gray-100">
    <h1 class="text-3xl font-bold text-gray-800 mb-2">Product SKU Scanner</h1>
    <p class="text-gray-500 mb-6">Click below to allow camera access and scan a barcode.</p>

    <button id="startScanBtn" class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-6 rounded-lg shadow-md transition duration-200 mb-4">
      Start Barcode Scan
    </button>

    <div id="reader" style="display:none;">
      <div id="scanner-line" class="scanner-line"></div>
    </div>

    <div class="mt-6 flex flex-col sm:flex-row gap-4">
      <input id="skuInput" type="text" placeholder="Enter SKU" 
        class="flex-1 p-3 border border-gray-300 rounded-lg focus:ring-4 focus:ring-blue-500/50 uppercase tracking-widest text-lg font-medium shadow-sm transition">
      <button id="lookupBtn" 
        class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg shadow-md transition duration-200">
        Lookup Image
      </button>
    </div>

    <div class="mt-8">
      <h2 class="text-xl font-semibold text-gray-700 mb-4">Product Preview:</h2>
      <div class="w-full aspect-square bg-gray-100 rounded-lg overflow-hidden shadow-inner flex items-center justify-center p-4">
        <img id="productImage" src="" alt="Product Image" class="w-full h-full object-contain rounded-lg transition-opacity duration-300 opacity-0"
          onload="this.classList.remove('opacity-0')">
        <div id="placeholder" class="text-gray-400 text-center">Enter or scan a SKU to view image.</div>
      </div>
    </div>

    <p id="statusMessage" class="mt-4 text-center text-sm text-gray-500"></p>
  </div>

  <!-- Local html5-qrcode -->
  <script src="js/html5-qrcode.min.js"></script>

  <script>
    function initScannerApp() {
      const IMAGE_BASE_URL = "https://img.faballey.com/images/Product/";
      const IMAGE_SUFFIX = "/3.jpg";
      const startBtn = document.getElementById("startScanBtn");
      const lookupBtn = document.getElementById("lookupBtn");
      const productImage = document.getElementById("productImage");
      const placeholder = document.getElementById("placeholder");
      const statusMsg = document.getElementById("statusMessage");
      const skuInput = document.getElementById("skuInput");
      const readerDiv = document.getElementById("reader");
      let html5Scanner = null;
      let isScanning = false;

      async function requestCameraPermission() {
        try {
          const stream = await navigator.mediaDevices.getUserMedia({ video: true });
          stream.getTracks().forEach(t => t.stop());
          return true;
        } catch (err) {
          alert("Camera access denied or unavailable. Please enable permissions.");
          console.error(err);
          return false;
        }
      }

      async function startScan() {
        const allowed = await requestCameraPermission();
        if (!allowed) return;

        if (!html5Scanner) html5Scanner = new Html5Qrcode("reader");
        readerDiv.style.display = "block";
        statusMsg.textContent = "ðŸ“· Scanning...";

        try {
          const devices = await Html5Qrcode.getCameras();
          if (!devices.length) {
            alert("No camera found.");
            return;
          }

          let cameraId = devices[0].id;
          const backCam = devices.find(d => (d.label || '').toLowerCase().includes('back') || (d.label || '').toLowerCase().includes('environment'));
          if (backCam) cameraId = backCam.id;

          isScanning = true;
          await html5Scanner.start(cameraId, { fps: 10, qrbox: { width: 250, height: 150 } }, onScanSuccess);
        } catch (err) {
          console.error("Error starting scan:", err);
          alert("Could not start scanning. Check console.");
        }
      }

      function stopScan() {
        if (isScanning && html5Scanner) {
          html5Scanner.stop().catch(console.error);
          isScanning = false;
          readerDiv.style.display = "none";
          statusMsg.textContent = "Scanner stopped.";
        }
      }

      function onScanSuccess(decodedText) {
        stopScan();
        const cleaned = decodedText.toUpperCase().trim().replace(/[^A-Z0-9-]/g, '');
        skuInput.value = cleaned;
        fetchImage();
        statusMsg.textContent = `âœ… Scanned: ${cleaned}`;
      }

      async function checkImageExists(url) {
        try {
          const res = await fetch(url, { method: "HEAD" });
          return res.ok;
        } catch {
          return false;
        }
      }

      async function fetchImage() {
        stopScan();
        const sku = skuInput.value.trim().toUpperCase();
        if (!sku) {
          placeholder.textContent = "Please enter a SKU.";
          productImage.src = "";
          productImage.classList.add("opacity-0");
          return;
        }

        placeholder.style.display = "none";
        statusMsg.textContent = `Searching image for SKU: ${sku}`;
        productImage.classList.add("opacity-0");

        const variants = [sku, ...Array.from({ length: 26 }, (_, i) => sku.slice(0, -1) + String.fromCharCode(65 + i))];
        let foundUrl = null;

        for (const variant of variants) {
          const url = `${IMAGE_BASE_URL}${variant}${IMAGE_SUFFIX}`;
          statusMsg.textContent = `Trying: ${variant}`;
          const exists = await checkImageExists(url);
          if (exists) {
            foundUrl = url;
            skuInput.value = variant;
            statusMsg.textContent = `âœ… Found image for ${variant}`;
            break;
          }
          // Wait 300ms between tries to avoid spam
          await new Promise(res => setTimeout(res, 300));
        }

        if (foundUrl) {
          productImage.src = foundUrl;
        } else {
          placeholder.style.display = "block";
          placeholder.textContent = "Image not found.";
          statusMsg.textContent = "âš ï¸ No matching image found for any variant.";
        }
      }

      function handleImageError(img) {
        img.src = "";
        img.classList.add("opacity-0");
        placeholder.style.display = "block";
        placeholder.textContent = "Image not found.";
        statusMsg.textContent = "âš ï¸ Image not found for this SKU.";
      }

      startBtn.addEventListener("click", () => isScanning ? stopScan() : startScan());
      lookupBtn.addEventListener("click", fetchImage);
      window.handleImageError = handleImageError;
    }

    window.onload = initScannerApp;
  </script>
</body>
</html>
