<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Barcode Scanner & SKU Lookup</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html5-qrcode/2.3.8/html5-qrcode.min.js"></script>

    <style>
        /* Base Styles */
        body { 
            background: #f5f8fc; 
            font-family: 'Inter', sans-serif; 
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            padding: 1rem;
        }

        /* Video Container Styling */
        #video-container { 
            position: relative; 
            border-radius: 12px; 
            overflow: hidden; 
            background: #000; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.2); 
            width: 100%;
            aspect-ratio: 16/9; /* Set a standard video aspect ratio */
        }
        
        /* Reader Container */
        #reader {
            width: 100%;
            height: 100%; 
            position: absolute; 
            top: 0;
            left: 0;
            z-index: 10;
        }

        /* Hide the default QR/Barcode line marker from the library */
        #reader div { display: none !important; }
        
        /* --- CUSTOM OVERLAY STYLES (Large Scan Box) --- */

        #scanner-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 20; 
            pointer-events: none; 
        }

        /* Define the visible scanning area */
        .scan-box {
            width: 90%; 
            height: 120px; /* Tall box suitable for linear barcodes */
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            border: 1px solid rgba(255, 255, 255, 0.3);
            /* Darkens the area outside the scan box */
            box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.5); 
            border-radius: 5px; 
        }

        /* Fast Scan Animation */
        .scan-strip {
            position: absolute; 
            left: 0;
            width: 100%;
            height: 4px; 
            background: linear-gradient(to right, transparent 10%, #ff0000 50%, transparent 90%);
            box-shadow: 0 0 10px rgba(255, 0, 0, 0.8);
            animation: scan 1s infinite linear alternate; 
        }

        @keyframes scan {
            0% { top: 0%; opacity: 0.8; }
            100% { top: calc(100% - 4px); opacity: 0.8; } 
        }

        .hidden {
            display: none !important;
        }

        /* Flash Button Styling */
        .flash-active {
            background-color: #facc15 !important; /* Yellow when on */
            color: #1f2937 !important; /* Dark text */
        }
        .flash-inactive {
            background-color: #6b7280 !important; /* Gray when off */
        }
    </style>
</head>

<body class="p-4">
    <div class="max-w-md bg-white rounded-2xl shadow-lg p-6">
        <h1 class="text-2xl font-bold text-center mb-2">FabAlley Barcode Scanner</h1>
        <p class="text-center text-gray-500 mb-4">Scan or enter SKU to decode and lookup</p>

        <div id="video-container" class="relative mb-4">
            <div id="reader" class="h-full"></div>
            <div id="scanner-overlay" class="hidden">
                <div class="scan-box">
                    <div class="scan-line">
                        <div class="scan-strip"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="flex gap-2 mb-3">
            <input id="skuInput" type="text" placeholder="ENTER SKU"
                class="flex-1 border border-gray-300 p-3 rounded-lg text-center text-lg uppercase font-semibold tracking-wider" />
            <button id="lookupBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-3 rounded-lg font-semibold">
                Lookup
            </button>
        </div>

        <div class="flex justify-center gap-2 mb-3">
            <button id="startBtn" class="bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-6 rounded-lg shadow-md">Start Scan</button>
            <button id="stopBtn" class="bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-6 rounded-lg shadow-md hidden" disabled>Stop</button>
            <button id="flashBtn" class="bg-gray-400 hover:bg-gray-500 text-white font-semibold py-2 px-4 rounded-lg shadow-md hidden" disabled>ðŸ’¡ Flash OFF</button>
        </div>

        <div id="statusMessage" class="text-center text-gray-600 text-sm mb-3">Scanner not active</div>

        <div class="relative max-w-full aspect-square bg-gray-100 rounded-lg overflow-hidden flex items-center justify-center p-4">
            <img id="productImage" src="" alt="Product Image" class="max-h-full object-contain opacity-0 transition-opacity duration-300" />
            <div id="placeholder" class="text-gray-400 text-center absolute">Enter or scan SKU</div>
        </div>
    </div>

    <script>
        const skuInput = document.getElementById("skuInput");
        const productImage = document.getElementById("productImage");
        const placeholder = document.getElementById("placeholder");
        const startBtn = document.getElementById("startBtn");
        const stopBtn = document.getElementById("stopBtn");
        const flashBtn = document.getElementById("flashBtn");
        const statusMsg = document.getElementById("statusMessage");
        const lookupBtn = document.getElementById("lookupBtn");
        const scannerOverlay = document.getElementById("scanner-overlay");
        
        const html5QrCode = new Html5Qrcode("reader");

        // Constants for image lookup (based on faballey URL structure)
        const IMAGE_BASE_URL = "https://img.faballey.com/images/Product/";
        const IMAGE_SUFFIX = "/1.jpg";
        const LETTERS = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ'; // Variants to check

        let lastScanned = "";
        let isScanning = false;
        let isLoading = false;
        let currentImageCheck = null; 
        let flashOn = false;        

        // --- Flashlight Control Logic ---

        async function toggleFlash() {
            if (!isScanning) return;
            
            flashBtn.disabled = true;

            try {
                await html5QrCode.setFlash(!flashOn);
                flashOn = !flashOn;
                
                flashBtn.classList.toggle("flash-active", flashOn);
                flashBtn.classList.toggle("flash-inactive", !flashOn);
                flashBtn.textContent = flashOn ? "ðŸ’¡ Flash ON" : "ðŸ’¡ Flash OFF";

                statusMsg.textContent = flashOn ? "ðŸ’¡ Flashlight ON" : "ðŸ’¡ Flashlight OFF";
                flashBtn.disabled = false;

            } catch (err) {
                console.error("Flash operation failed.", err);
                statusMsg.textContent = "Flash unsupported/denied. Button disabled.";
                flashBtn.classList.add("hidden");
                flashBtn.disabled = true;
                flashOn = false;
            }
        }
        
        function resetFlashUI() {
            flashBtn.classList.add("hidden");
            flashBtn.classList.remove("flash-active", "flash-inactive");
            flashBtn.disabled = true;
            flashOn = false;
        }

        // --- Core UI & Scanner Logic ---

        function resetUI() {
            productImage.classList.add("opacity-0");
            productImage.removeAttribute("src");
            placeholder.style.display = "block";
            placeholder.textContent = "Enter or scan SKU";
        }

        async function onScanSuccess(decodedText, decodedResult) {
            const code = decodedText.trim().toUpperCase();
            
            if (code === lastScanned && !isLoading) {
                return;
            }
            if (isLoading) return;

            // Haptic feedback
            if (navigator.vibrate) navigator.vibrate(200);

            lastScanned = code;
            statusMsg.textContent = `âœ… SKU Detected: ${code}`;
            skuInput.value = code;
            await fetchImage(code);
        }

        async function startScanner() {
            if (isScanning) return;
            resetUI();
            resetFlashUI();
            statusMsg.textContent = "Starting camera...";
            startBtn.classList.add("hidden");
            stopBtn.classList.remove("hidden");
            stopBtn.disabled = true;
            scannerOverlay.classList.remove("hidden");

            const scannerConfig = {
                fps: 60, 
                qrbox: { width: 300, height: 120 }, 
                formatsToSupport: [
                    Html5QrcodeSupportedFormats.CODE_128,
                    Html5QrcodeSupportedFormats.CODE_39,
                    Html5QrcodeSupportedFormats.EAN_13, 
                    Html5QrcodeSupportedFormats.EAN_8,   
                ],
            };
            
            // Attempt 1: Start with torch (best for low light/mobile)
            const preferredCameraConstraints = {
                facingMode: "environment",
                video: { facingMode: "environment", advanced: [{ torch: true }] }
            };

            let success = false;
            try {
                await html5QrCode.start(preferredCameraConstraints, scannerConfig, onScanSuccess, () => {});
                success = true;
                flashOn = true; 
                statusMsg.textContent = "ðŸš€ Scanning at full speed (Flash ON!)...";
            } catch (err) {
                console.warn("Direct torch start failed. Trying standard start.", err);

                // Attempt 2: Fallback to standard start without torch
                try {
                    const fallbackConstraints = { facingMode: "environment" };
                    await html5QrCode.start(fallbackConstraints, scannerConfig, onScanSuccess, () => {});
                    success = true;
                    flashOn = false; 
                    statusMsg.textContent = "ðŸš€ Scanning at full speed (Flash OFF)...";
                } catch (fallbackError) {
                       console.error("Failed to start scanner even with fallback: ", fallbackError);
                       alert(`CAMERA STARTUP FAILED!\n\nCheck HTTPS/Permissions. Error: ${fallbackError.message}`);
                       
                       statusMsg.textContent = "ðŸ”´ CAMERA ERROR: Check HTTPS/Permissions.";
                       startBtn.classList.remove("hidden");
                       stopBtn.classList.add("hidden");
                       scannerOverlay.classList.add("hidden"); 
                }
            }

            if (success) {
                isScanning = true;
                stopBtn.disabled = false;
                
                flashBtn.classList.remove("hidden");
                flashBtn.disabled = false; 
                flashBtn.textContent = flashOn ? "ðŸ’¡ Flash ON" : "ðŸ’¡ Flash OFF";
                flashBtn.classList.toggle("flash-active", flashOn);
                flashBtn.classList.toggle("flash-inactive", !flashOn);
            }
        }

        // --- RELIABLE STOP FIX ---
        async function stopScanner() {
            if (!isScanning) return;
            
            // 1. Attempt to turn off the flash
            try {
                await html5QrCode.setFlash(false);
            } catch(e) { console.warn("Error turning off flash during stop.", e); }

            // 2. Stop the camera stream
            html5QrCode.stop().then(() => {
                console.log("Camera stream successfully stopped.");
            }).catch(err => {
                console.error("Error stopping camera stream.", err);
                statusMsg.textContent = "Error stopping stream. Camera may be active.";
            }).finally(() => {
                // 3. Guarantee UI reset and state change
                isScanning = false;
                startBtn.classList.remove("hidden");
                stopBtn.classList.add("hidden");
                stopBtn.disabled = true;
                scannerOverlay.classList.add("hidden"); 
                statusMsg.textContent = "Scanner stopped.";
                lastScanned = ""; 
                resetFlashUI();
            });
        }

        // --- Image Lookup Logic (with Variant Fallback) ---

        function fetchImage(fullSku) {
            if (currentImageCheck) {
                clearTimeout(currentImageCheck);
            }
            isLoading = true;
            skuInput.value = fullSku;
            resetUI();
            placeholder.textContent = "Loading...";
            statusMsg.textContent = `Loading image for ${fullSku}...`;
            
            // Get the SKU base (e.g., XMS29747 from XMS29747C)
            const baseSku = fullSku.slice(0, -1);
            let index = 0;

            function attemptImageLoad() {
                // Stop if a new SKU lookup has been initiated
                if (skuInput.value.trim().toUpperCase() !== fullSku) {
                    isLoading = false;
                    return;
                }
                
                // Stop if all letters A-Z have been checked
                if (index >= LETTERS.length) {
                    isLoading = false;
                    statusMsg.textContent = "âš ï¸ No image found after checking all variants.";
                    placeholder.style.display = "block";
                    placeholder.textContent = `Image not found for SKU: ${fullSku} (variants A-Z checked)`;
                    return;
                }

                // Construct the variant SKU (e.g., XMS29747A)
                const variantChar = LETTERS.charAt(index);
                const folder = baseSku + variantChar;
                const url = `${IMAGE_BASE_URL}${folder}${IMAGE_SUFFIX}`;
                
                const img = new window.Image();

                img.onload = function () {
                    // SUCCESS: Image found. Stop searching and display.
                    isLoading = false;
                    const foundSku = folder;
                    placeholder.style.display = "none";

                    // Use the built-in image element load to handle fade-in effect
                    productImage.onload = () => {
                        productImage.classList.remove("opacity-0");
                        statusMsg.textContent = `âœ… Image loaded for ${fullSku} (Found Variant: ${foundSku})`;
                        productImage.onload = null;
                    };
                    
                    productImage.onerror = () => {
                        statusMsg.textContent = `âš ï¸ Failed to display image for ${fullSku}`;
                        resetUI();
                        placeholder.textContent = "Image failed to load.";
                        productImage.onerror = null;
                    };
                    
                    productImage.src = url; 
                    clearTimeout(currentImageCheck);
                };

                img.onerror = function () {
                    // FAIL: Image not found for this variant. Try the next letter instantly.
                    index += 1;
                    currentImageCheck = setTimeout(attemptImageLoad, 0); 
                };

                img.src = url; // Initiate image load attempt
            }

            attemptImageLoad();
        }

        // --- Event Listeners ---

        lookupBtn.addEventListener("click", () => {
            const sku = skuInput.value.trim().toUpperCase();
            if (sku) fetchImage(sku);
        });

        skuInput.addEventListener("keydown", (e) => {
            if (e.key === "Enter") {
                e.preventDefault();
                const sku = skuInput.value.trim().toUpperCase();
                if (sku) fetchImage(sku);
            }
        });

        startBtn.addEventListener("click", startScanner);
        stopBtn.addEventListener("click", stopScanner);
        flashBtn.addEventListener("click", toggleFlash); 

        // Initial setup
        resetUI();
    </script>
</body>
</html>
