<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Fast Barcode + SKU Image Viewer</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f9fafb;
      text-align: center;
      padding: 20px;
    }
    video {
      width: 480px;
      height: 360px;
      border: 2px solid #333;
      border-radius: 10px;
      margin-top: 10px;
    }
    #productImage {
      width: 300px;
      height: 300px;
      object-fit: contain;
      border: 2px solid #ddd;
      border-radius: 10px;
      margin-top: 20px;
      background-color: #f3f3f3;
    }
    #skuInput {
      margin-top: 20px;
      padding: 10px;
      font-size: 18px;
      text-transform: uppercase;
      width: 250px;
    }
    button {
      margin-top: 10px;
      padding: 10px 20px;
      font-size: 16px;
      background-color: #2563eb;
      color: #fff;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }
    button:hover {
      background-color: #1d4ed8;
    }
    #result {
      margin-top: 10px;
      font-size: 18px;
      font-weight: bold;
      color: #16a34a;
    }
  </style>
</head>
<body>
  <h1>ðŸ“¦ Fast Barcode Scanner + SKU Image Loader</h1>
  <p>Point your camera at a barcode to scan instantly.</p>

  <video id="videoElement" autoplay></video>
  <div id="result">Waiting for barcode...</div>

  <input id="skuInput" type="text" placeholder="Enter SKU manually">
  <button id="lookupBtn">Load Image</button>

  <div>
    <img id="productImage" src="" alt="Product image will appear here">
  </div>

  <!-- Load local QuaggaJS -->
  <script src="quagga.min.js"></script>

  <script>
    const video = document.getElementById('videoElement');
    const result = document.getElementById('result');
    const skuInput = document.getElementById('skuInput');
    const lookupBtn = document.getElementById('lookupBtn');
    const productImage = document.getElementById('productImage');

    const IMAGE_BASE_URL = "https://img.faballey.com/images/Product/";
    const IMAGE_SUFFIX = "/1.jpg";

    // âœ… Request camera access (your old working logic)
    if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
      navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
        .then(stream => {
          video.srcObject = stream;
          video.play();
          startQuagga();
        })
        .catch(err => {
          console.error("Camera access error:", err);
          alert("Unable to access camera. Please allow permissions.");
        });
    } else {
      alert("Your browser does not support camera access.");
    }

    // âœ… Start QuaggaJS barcode scanner
    function startQuagga() {
      Quagga.init({
        inputStream: {
          name: "Live",
          type: "LiveStream",
          target: video, // attach to same working camera
          constraints: { facingMode: "environment" }
        },
        decoder: {
          readers: ["code_128_reader", "code_39_reader", "ean_reader"]
        }
      }, function (err) {
        if (err) {
          console.error("Quagga init failed:", err);
          return;
        }
        Quagga.start();
        console.log("Quagga started successfully!");
      });

      Quagga.onDetected(data => {
        const code = data.codeResult.code.trim().toUpperCase();
        result.textContent = "âœ… Barcode Detected: " + code;
        skuInput.value = code;
        fetchImage(code);

        // Stop after first detection (optional)
        Quagga.stop();
      });
    }

    // âœ… Load product image by SKU (with Aâ€“Z fallback)
    async function fetchImage(sku) {
      if (!sku) return;
      result.textContent = "ðŸ” Loading image for SKU: " + sku;

      const baseSku = sku.slice(0, -1);
      const lastChar = sku.slice(-1).toUpperCase();
      const candidates = [lastChar, ...'ABCDEFGHIJKLMNOPQRSTUVWXYZ'.split('').filter(c => c !== lastChar)];

      for (let char of candidates) {
        const url = `${IMAGE_BASE_URL}${baseSku}${char}${IMAGE_SUFFIX}`;
        try {
          const res = await fetch(url, { method: "HEAD" });
          if (res.ok) {
            productImage.src = url;
            result.textContent = `âœ… Image loaded for ${baseSku}${char}`;
            return;
          } else {
            await new Promise(r => setTimeout(r, 300)); // wait between requests
          }
        } catch (err) {
          console.warn("Image not found:", baseSku + char);
        }
      }
      result.textContent = "âš ï¸ No image found for this SKU.";
      productImage.src = "";
    }

    lookupBtn.addEventListener('click', () => {
      const sku = skuInput.value.trim().toUpperCase();
      fetchImage(sku);
    });
  </script>
</body>
</html>
