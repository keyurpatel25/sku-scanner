<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Camera Access Test</title>
    
    <style>
        #reader { width: 320px; height: 240px; border: 2px solid green; margin-top: 10px; }
    </style>
</head>

<body>
    <h1>Camera Permission Test</h1>

    <button id="scanButton">Start Camera Test</button>
    
    <div id="reader" style="display: none;"></div>
    
    <p id="statusMessage">
        Status: Click the button and watch the address bar for a camera icon.
    </p>

    <script src="https://unpkg.com/html5-qrcode@2.3.8/dist/html5-qrcode.min.js"></script>

    <script>
        window.addEventListener("DOMContentLoaded", () => {
            
            const STATUS_MESSAGE = document.getElementById('statusMessage');
            const READER_DIV = document.getElementById('reader');
            const SCAN_BUTTON = document.getElementById('scanButton');

            let html5QrcodeScanner = null;

            function initAndStartScanner() {
                // Initialize the scanner
                if (!html5QrcodeScanner && window.Html5Qrcode) {
                    html5QrcodeScanner = new Html5Qrcode("reader");
                }
                
                if (!html5QrcodeScanner) {
                    // This error should now only occur if the library failed to download
                    STATUS_MESSAGE.textContent = 'Error: Scanner library not ready (check console network errors).';
                    return;
                }

                STATUS_MESSAGE.textContent = 'Requesting camera permission...';
                READER_DIV.style.display = 'block';

                const config = { fps: 10, qrbox: { width: 250, height: 150 } };
                
                // The start call triggers the permission request
                html5QrcodeScanner.start(
                    { facingMode: "environment" }, // Try to force the back camera
                    config, 
                    (decodedText) => {
                        html5QrcodeScanner.stop().catch(console.error);
                        READER_DIV.style.display = 'none';
                        STATUS_MESSAGE.textContent = `✅ Successfully Scanned: ${decodedText}`;
                    }, 
                    () => {} 
                ).catch((err) => {
                    // This catches the PermissionDeniedError
                    STATUS_MESSAGE.textContent = '❌ Failed to start camera. Check that you are on HTTPS and permissions are allowed.';
                    console.error("Camera Start Error:", err);
                    READER_DIV.style.display = 'none';
                });
            }

            SCAN_BUTTON.addEventListener("click", initAndStartScanner);
        });
    </script>
</body>
</html>
